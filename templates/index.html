<!DOCTYPE HTML>
<html>
<head>
<title>Mustard Mine</title>
<link rel="stylesheet" href="/static/main.css">
</head>
<body>
<ul class=menu><li>{{ twitter | safe }}</li></ul>
<p>Welcome, {{ username }}!</p>
<table border=1 id=setups></table>
<form method=post action="/update">
<table>
<tr><td><label for=category>Category:</label></td><td><input id=category name=category size=50></td></tr>
<tr><td><label for=title>Stream title:</label></td><td><input id=title name=title size=50></td></tr>
<tr><td><label for=comm1>Communities:</label></td><td><input id=comm1 name=comm1 size=50></td></tr>
<tr><td></td><td><input name=comm2 size=50></td></tr>
<tr><td></td><td><input name=comm3 size=50></td></tr>
</table>
<input type=submit value="Update stream info"> <button type=button onclick="save()">Save this setup</button>
<script>
const channel = {{ channel | safe }};
const communities = {{ commnames | safe }};
const setups = {{ setups | safe }};
const form = document.forms[0].elements;
form.category.value = channel.game;
form.title.value = channel.status;
communities.forEach((c, i) => form["comm"+(i+1)].value = c);
render_setups();

function render_setups() {
	const html = setups.map(s => `
		<tr onclick="pick_setup({s.id})">
			<td>${s.category}</td>
			<td>${s.title}</td>
			<td>${s.communities.join(", ")}</td>
		</tr>
	`);
	document.getElementById("setups").innerHTML =
		"<tr><th>Category</th><th>Title</th><th>Communities</th></tr>" +
		html.join("");
}

async function hello() {
	const result = await (await fetch("/api/hello", {credentials: "include"})).json();
	console.log(result);
}

async function save() {
	const result = await (await fetch("/api/setups", {
		credentials: "include",
		headers: {"Content-Type": "application/json"},
		method: "POST",
		body: JSON.stringify({
			category: form.category.value,
			title: form.title.value,
			communities: [
				form.comm1.value,
				form.comm2.value,
				form.comm3.value,
			].filter(x=>x), //Remove any blank communities
		})
	})).json();
	setups.push(result);
	render_setups();
}
</script>
</form>
<form method=post action="/tweet">
<p><label>Tweet that you're live: <input name=tweet size=50></label><input type=submit value="Tweet!"></p>
</form>
<button type=button onclick="hello()">Hello, world</button>
<p><a href="/logout">Logout</a></p>
</body>
</html>
