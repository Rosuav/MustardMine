<!DOCTYPE HTML>
<html>
<head>
<title>Mustard Mine</title>
<link rel="stylesheet" href="/static/main.css">
</head>
<body>
<ul class=menu><li>{{ twitter | safe }}</li></ul>
<p>Welcome, {{ username }}!</p>
<table border=1 id=setups></table>
<form method=post action="/update">
<table>
<tr><td><label for=category>Category:</label></td><td><input id=category name=category size=50></td></tr>
<tr><td><label for=title>Stream title:</label></td><td><input id=title name=title size=50></td></tr>
<tr><td><label for=comm1>Communities:</label></td><td><input id=comm1 name=comm1 size=50></td></tr>
<tr><td></td><td><input name=comm2 size=50></td></tr>
<tr><td></td><td><input name=comm3 size=50></td></tr>
</table>
<input type=submit value="Update stream info"> <button type=button onclick="save()">Save this setup</button>
<script>
const channel = {{ channel | safe }};
const communities = {{ commnames | safe }};
let setups = {{ setups | safe }};
const form = document.forms[0].elements;
form.category.value = channel.game;
form.title.value = channel.status;
communities.forEach((c, i) => form["comm"+(i+1)].value = c);
render_setups();

function render_setups() {
	const html = setups.map((s, i) => `
		<tr onclick="pick_setup(${i})">
			<td>${s.category}</td>
			<td>${s.title}</td>
			<td>${s.communities.join(", ")}</td>
			<td><button class="deleting" id="del${i}" onclick="try_delete_setup(${i})">X</button></td>
		</tr>
	`);
	document.getElementById("setups").innerHTML =
		"<tr><th>Category</th><th>Title</th><th>Communities</th></tr>" +
		html.join("");
}

function pick_setup(i) {
	const setup = setups[i];
	if (!setup) return; //Shouldn't happen
	form.category.value = setup.category;
	form.title.value = setup.title;
	setup.communities.forEach((c, i) => form["comm"+(i+1)].value = c);
}
</script><script> //<==satisfy editor
let deleting_setup = -1;
let delete_time = 0;
function try_delete_setup(i) {
	if (deleting_setup != i) {
		//Await confirmation via a second click
		document.querySelectorAll(".deleting").forEach(b => b.innerHTML = "X");
		document.getElementById("del" + i).innerHTML = "Delete?";
		deleting_setup = i;
		delete_time = +new Date + 1;
		return;
	}
	if (+new Date < delete_time) return;
	//Okay, let's actually delete it.
	deleting_setup = -1;
	document.getElementById("del" + i).innerHTML = "X";
	delete_setup(setups[i].id);
}

async function hello() {
	const result = await (await fetch("/api/hello", {credentials: "include"})).json();
	console.log(result);
}

async function save() {
	const result = await (await fetch("/api/setups", {
		credentials: "include",
		headers: {"Content-Type": "application/json"},
		method: "POST",
		body: JSON.stringify({
			category: form.category.value,
			title: form.title.value,
			communities: [
				form.comm1.value,
				form.comm2.value,
				form.comm3.value,
			].filter(x=>x), //Remove any blank communities
		})
	})).json();
	setups.push(result);
	render_setups();
}

async function delete_setup(i) {
	const result = await fetch("/api/setups/" + i, {
		credentials: "include",
		method: "DELETE",
	});
	if (!result.ok) return;
	setups = await (await fetch("/api/setups", {credentials: "include"})).json();
	render_setups();
}
</script>
</form>
<form method=post action="/tweet">
<p><label>Tweet that you're live: <input name=tweet size=50></label><input type=submit value="Tweet!"></p>
</form>
<button type=button onclick="hello()">Hello, world</button>
<p><a href="/logout">Logout</a></p>
</body>
</html>
