<!DOCTYPE HTML>
<html>
<head>
<title>Mustard Mine - {{ title }}</title>
<style>
#id {display: none;}
div {
	font-weight: 400;
	font-size: 12em;
}
/* Custom CSS can make use of selector "#time.now" to affect the "NOW" display */
</style>
</head>
<body>
<div id=id>{{ id }}</div>
<div id=time></div>
<script>
let target_time = {{ next_event }} + {{ delta }};
const maxtime = {{ maxtime }};
let target = new Date(target_time * 1000);
const display = document.getElementById("time");
function update() {
	const delay = Math.floor((target - new Date()) / 1000);
	if (delay <= 0 || delay >= maxtime) {
		display.innerHTML = "NOW";
		display.classList.add("now");
		set_delay(60000);
	} else {
		const min = Math.floor(delay / 60);
		const sec = delay % 60;
		display.innerHTML = min + ":" + ("0" + sec).slice(-2);
		display.classList.remove("now");
		set_delay(1000);
	}
}
let timer = null, delay = 0;
function set_delay(wanted_delay) {
	if (wanted_delay === delay) return;
	if (timer) clearInterval(timer);
	timer = setInterval(update, delay = wanted_delay);
}
update();

const protocol = window.location.protocol == "https:" ? "wss://" : "ws://";
let socket;
function init_socket() {
	socket = new WebSocket(protocol + window.location.host + "/countdown_ctrl");
	socket.onopen = () => {socket.send(JSON.stringify({type: "init", id: "{{id}}"}));};
	socket.onmessage = (ev) => {
		const msg = JSON.parse(ev.data);
		switch (msg.type) {
			case "inited": console.log("Mustard-Mine control connection established."); break;
			case "adjust":
				//Add or subtract some seconds from the clock
				target_time += msg.delta;
				target = new Date(target_time * 1000);
				update();
				break;
			case "force":
				//Force the clock to show a specific value
				target_time = new Date()/1000 + msg.time;
				target = new Date(target_time * 1000);
				update();
				break;
			//Maybe TODO: Reset the target time to a specific Unix time
			//That would allow the admin to say "okay now recalculate for a new event"
		}
	};
	socket.onclose = ev => {
		console.error("Socket closed: " + ev.code + " " + ev.reason);
		if (ev.wasClean) console.info("Was a clean shutdown");
		else console.error("Not a clean shutdown");
	};
}
init_socket();
</script>
</body>
</html>
